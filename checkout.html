<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Telangana State Dental Conference - Checkout</title>

    <!--=====FAB ICON=======-->
    <link rel="shortcut icon" href="assets/img/logoo.jpg" />

    <!--===== CSS LINK =======-->
    <link rel="stylesheet" href="assets/css/vendor/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/vendor/aos.css" />
    <link rel="stylesheet" href="assets/css/vendor/fontawesome.css" />
    <link rel="stylesheet" href="assets/css/vendor/magnific-popup.css" />
    <link rel="stylesheet" href="assets/css/vendor/mobile.css" />
    <link rel="stylesheet" href="assets/css/vendor/owlcarousel.min.css" />
    <link rel="stylesheet" href="assets/css/vendor/sidebar.css" />
    <link rel="stylesheet" href="assets/css/vendor/slick-slider.css" />
    <link rel="stylesheet" href="assets/css/vendor/nice-select.css" />
    <link rel="stylesheet" href="assets/css/vendor/odometer.css" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <!--=====  JS SCRIPT LINK =======-->
    <script src="assets/js/vendor/jquery-3.7.1.min.js"></script>
    <style>
        .checkout-section {
            padding-top: 150px;
            padding-bottom: 100px;
        }

        .checkout-card {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 40px;
            background: #fff;
        }

        .amount-display {
            font-size: 2.5rem;
            color: #0a6ebd;
            font-weight: bold;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
        }

        .detail-value {
            font-weight: 700;
            color: #333;
        }

        /* LOADER STYLES */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            display: none;
            /* Hidden by default */
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #0a6ebd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            font-size: 1.5rem;
            color: #333;
            font-weight: 600;
        }
    </style>
</head>

<body class="homepage4-body">

    <!-- LOADER HTML -->
    <div id="paymentLoader" class="loader-overlay">
        <div class="spinner"></div>
        <div class="loader-text">Processing Payment...</div>
        <p class="text-muted mt-2">Please do not close this window</p>
    </div>

    <!--=====HEADER START=======-->
    <header>
        <div class="header-area homepage4 header header-sticky d-none d-lg-block" id="header">
            <div class="container-fluid p-0">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="header-elements">
                            <div class="site-logo">
                                <a href="index.html"><img src="assets/img/trant-logo.png" alt="" /></a>
                            </div>
                            <div class="main-menu">
                                <ul>
                                    <li><a href="index.html">Home</a></li>
                                    <li><a href="about.html">About Event</a></li>
                                    <li><a href="register.html">Register</a></li>
                                    <li>
                                        <a href="#">Downloads <i class="fa-solid fa-angle-down"></i></a>
                                        <ul class="dropdown-padding">
                                            <!-- <li><a href="assets/doc/10th TELANGANA STATE DENTAL CONFERENCE.pdf"
                                                    target="_blank">10th TELANGANA STATE DENTAL CONFERENCE</a></li> -->
                                            <li><a href="assets/doc/Clinical case competition .pdf"
                                                    target="_blank">Clinical Case
                                                    Competition</a></li>
                                            <li><a href="assets/doc/Paper and poster presentaion poster.pdf"
                                                    target="_blank">Paper & Poster Presentation Guidelines</a>
                                            </li>
                                            <li><a href="assets/doc/Cultural event guidelines.pdf"
                                                    target="_blank">Cultural Event Guidelines</a></li>
                                            <li><a href="assets/doc/TRADE LAYOUT.pdf" target="_blank">Trade
                                                    Layout</a></li>
                                        </ul>
                                    </li>
                                    <li><a href="cultural.html">Cultural</a></li>
                                    <li><a href="contact.html">Contact Us</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!--=====HEADER END =======-->

    <div class="container checkout-section">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="checkout-card">
                    <h2 class="text-center mb-4">Registration Checkout</h2>

                    <div class="text-center mb-5">
                        <p class="mb-2">Total Amount to Pay</p>
                        <div class="amount-display">₹ <span id="displayAmount">0</span></div>
                        <p class="text-muted">+ (2% Platform Fee)</p>
                    </div>

                    <div class="checkout-details mb-4">
                        <div class="detail-row">
                            <span class="detail-label">Registration ID</span>
                            <span class="detail-value" id="dispRegId">...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Name</span>
                            <span class="detail-value" id="dispName">...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Category</span>
                            <span class="detail-value" id="dispCategory">...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Email</span>
                            <span class="detail-value" id="dispEmail">...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Mobile</span>
                            <span class="detail-value" id="dispMobile">...</span>
                        </div>
                    </div>

                    <button id="payNowBtn" class="btn btn-primary w-100 btn-lg">Pay Now</button>
                </div>
            </div>
        </div>
    </div>

    <!--===== FOOTER AREA STARTS =======-->
    <div class="footer4-sertion-area">
        <div class="container">
            <div class="row">

                <!-- Logo & Description -->
                <div class="col-lg-3 col-md-6">
                    <div class="footer-logo-area">
                        <img src="assets/img/trant-logo.png" alt="" />
                        <div class="space16"></div>
                        <p>
                            The 10ᵗʰ Telangana State Dental Conference brings together dental professionals,
                            clinicians, students, and experts to share knowledge, advancements, and innovations
                            in modern dentistry.
                        </p>
                        <div class="space24"></div>
                        <ul>
                            <li><a href="#"><i class="fa-brands fa-facebook-f"></i></a></li>
                            <li><a href="#"><i class="fa-brands fa-instagram"></i></a></li>
                            <li><a href="#"><i class="fa-brands fa-linkedin-in"></i></a></li>
                            <li><a href="#" class="m-0"><i class="fa-brands fa-pinterest-p"></i></a></li>
                        </ul>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="col-lg-3 col-md-6">
                    <div class="link-content">
                        <h3>Quick Links</h3>
                        <ul>
                            <li><a href="about.html">About Event</a></li>
                            <li><a href="register.html">Registration</a></li>
                            <li><a href="contact.html">Contact Us</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="link-content2">
                        <h3>Email Support</h3>
                        <ul>
                            <li>
                                <a href="mailto:info@tgsdc.org">
                                    <img src="assets/img/icons/mail1.svg" alt="" />
                                    <span><strong>Contact:</strong><br>info@tgsdc.org</span>
                                </a>
                            </li>
                            <li>
                                <a href="mailto:posters@tgsdc.org">
                                    <img src="assets/img/icons/mail1.svg" alt="" />
                                    <span><strong>Posters:</strong><br>posters@tgsdc.org</span>
                                </a>
                            </li>
                            <li>
                                <a href="mailto:papers@tgsdc.org">
                                    <img src="assets/img/icons/mail1.svg" alt="" />
                                    <span><strong>Papers:</strong><br>papers@tgsdc.org</span>
                                </a>
                            </li>
                            <li>
                                <a href="mailto:registration@tgsdc.org">
                                    <img src="assets/img/icons/mail1.svg" alt="" />
                                    <span><strong>Registration:</strong><br>registration@tgsdc.org</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <!-- Contact Info -->
                <div class="col-lg-3 col-md-6">
                    <div class="link-content2">
                        <h3>Contact Us</h3>
                        <ul>
                            <li>
                                <a href="tel:+919985889140">
                                    <img src="assets/img/icons/phn1.svg" alt="" />+91 99858 89140
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <img src="assets/img/icons/location1.svg" alt="" />
                                    IDA Cyberabad Branch, Telangana
                                </a>
                            </li>

                            <li>
                                <a href="https://www.tgsdc.org">
                                    <img src="assets/img/icons/world1.svg" alt="" />www.tgsdc.org
                                </a>
                            </li>
                        </ul>
                        <div class="space24 "></div>
                        <div class="link-content2" style="padding-left: 20px;">
                            <h3>Sponsors</h3>
                            <ul style="display: flex; gap: 15px; align-items: center; padding: 0; list-style: none;">
                                <li>
                                    <img src="assets/img/ida/col.webp" alt="Sponsor"
                                        style="max-height: 50px; width: auto;" />
                                </li>
                                <li>
                                    <img src="assets/img/ida/bioline.webp" alt="Sponsor"
                                        style="max-height: 50px; width: auto;" />
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Footer Gallery -->


            </div>

            <div class="space60"></div>

            <!-- Copyright -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="copyright">
                        <p>&copy; Copyright 2025 - TGSDC.
                            All Rights Reserved | Hosted by IDA Cyberabad Branch <br>
                            Designed by <a href="https://thepatternscompany.com/" target="_blank"
                                style="color: inherit; text-decoration: underline;">The Patterns Company</a></p>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <!--===== FOOTER AREA ENDS =======-->

    <!--===== JS SCRIPT LINK =======-->
    <script src="assets/js/vendor/bootstrap.min.js"></script>
    <script>
        // CONFIGURATION - CHANGE THIS FOR LIVE DEPLOYMENT
        // const API_BASE_URL = "https://your-live-backend.com"; 
        const API_BASE_URL = "http://localhost:5000";

        // CHECKOUT LOGIC
        let regData = null;

        window.onload = function () {
            const storedData = localStorage.getItem("reg_payload");
            if (!storedData) {
                alert("No registration data found. Redirecting to registration page.");
                window.location.href = "register.html";
                return;
            }

            regData = JSON.parse(storedData);
            const amount = Number(regData.amount); // base amount
            const percentage = 2; // 2% charge

            const charge = (amount * percentage) / 100;
            const totalAmount = amount + charge;

            // Populate UI
            document.getElementById("displayAmount").innerText = totalAmount;
            document.getElementById("dispRegId").innerText = regData.reg_id;
            document.getElementById("dispName").innerText = regData.name;
            document.getElementById("dispCategory").innerText = regData.reg_type;
            document.getElementById("dispEmail").innerText = regData.email;
            document.getElementById("dispMobile").innerText = regData.mobile;
        };

        document.getElementById("payNowBtn").onclick = async function () {
            if (!regData) return;

            try {
                console.log("Initiating payment with API:", API_BASE_URL);

                // 1️⃣ GET RAZORPAY KEY
                let keyRes = await fetch(`${API_BASE_URL}/api/get-razorpay-key`);
                if (!keyRes.ok) throw new Error(`Failed to fetch key: ${keyRes.status} ${keyRes.statusText}`);

                let keyJson = await keyRes.json();
                const RAZORPAY_KEY = keyJson.key;

                // Recalculate Total Amount with 2% fee
                const amount = Number(regData.amount);
                const percentage = 2;
                const charge = (amount * percentage) / 100;
                const totalAmount = Math.round(amount + charge); // Rounding is safer for payment gateways

                // 2️⃣ CREATE ORDER
                let orderRes = await fetch(`${API_BASE_URL}/api/create-order`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        amount: totalAmount,
                        reg_id: regData.reg_id
                    })
                });

                if (!orderRes.ok) throw new Error(`Order API failed: ${orderRes.status} ${orderRes.statusText}`);

                let orderJson = await orderRes.json();
                if (!orderJson.success) throw new Error(orderJson.error || "Order creation failed!");

                const order = orderJson.order;

                // 3️⃣ OPEN RAZORPAY
                var options = {
                    key: RAZORPAY_KEY,
                    amount: order.amount,
                    currency: "INR",
                    name: "Telangana State Dental Conference",
                    description: "Registration ID: " + regData.reg_id,
                    order_id: order.id,

                    handler: async function (response) {
                        // SHOW LOADER IMMEDIATELY
                        document.getElementById("paymentLoader").style.display = "flex";

                        try {
                            // 4️⃣ VERIFY PAYMENT
                            console.log("Verifying payment...");
                            let verifyRes = await fetch(`${API_BASE_URL}/api/verify-payment`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    reg_id: regData.reg_id,
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_order_id: response.razorpay_order_id
                                })
                            });

                            if (!verifyRes.ok) {
                                throw new Error(`Verify failed: ${verifyRes.status} ${verifyRes.statusText}`);
                            }

                            let verifyJson = await verifyRes.json();
                            if (verifyJson.success) {
                                localStorage.removeItem("reg_payload"); // Clean up
                                window.location.href = "success.html";
                            } else {
                                throw new Error(verifyJson.error || "Verification success=false");
                            }
                        } catch (verifyErr) {
                            document.getElementById("paymentLoader").style.display = "none";
                            console.error("Verification Error:", verifyErr);
                            // Only show alert if it's not a successful redirect (which shouldn't happen here anyway)
                            alert("Payment verification failed. Please contact support. Error: " + verifyErr.message);
                        }
                    },

                    prefill: {
                        name: regData.name,
                        email: regData.email,
                        contact: regData.mobile
                    },
                    theme: { color: "#0a6ebd" },
                    modal: {
                        ondismiss: function () {
                            console.log('Checkout form closed');
                        }
                    }
                };

                var rzp = new Razorpay(options);
                rzp.on('payment.failed', function (response) {
                    console.error("Razorpay Payment Failed:", response.error);
                    alert("Payment Failed: " + response.error.description);
                });
                rzp.open();

            } catch (err) {
                console.error("Process Error:", err);
                alert("Error: " + err.message);
            }
        };
    </script>
</body>

</html>